var e,t=o({},require("@turf/turf")),n=(e=require("moment"))&&e.__esModule?e.default:e,r=o({},require("leaflet")),a=o({},require("esri-leaflet"));function o(e,t){return Object.keys(t).forEach((function(n){"default"!==n&&"__esModule"!==n&&Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[n]}})})),e}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}require("./index.css");var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.form=document.createElement("form"),this.form.className="sms-sign-up"}var t,n,r;return t=e,(n=[{key:"buildForm",value:function(e){console.log(e);var t=document.createElement("input");t.type="phone",t.placeholder="Enter phone - numbers only.",t.setAttribute("id","phone"),t.setAttribute("minlength",13),t.setAttribute("required",!0),t.addEventListener("keyup",(function(t){e.signup.phoneFormat(t,e.signup)}));var n=document.createElement("label");n.innerText="Phone",n.setAttribute("for","phone");var r=document.createElement("div");r.className="container-box",r.appendChild(n),r.appendChild(t);var a=document.createElement("input");a.type="checkbox",a.setAttribute("id","trash"),a.value=e.data.next_pickups.trash.route,a.name="service-signup",a.setAttribute("checked",!0);var o=document.createElement("label");o.innerText="Garbage",o.setAttribute("for","trash");var i=document.createElement("div");i.className="checkbox-container-box",i.appendChild(a),i.appendChild(o);var l=document.createElement("input");l.type="checkbox",l.setAttribute("id","recycling"),l.value=e.data.next_pickups.recycling.route,l.name="service-signup",l.setAttribute("checked",!0);var s=document.createElement("label");s.innerText="Recycle",s.setAttribute("for","recycling");var c=document.createElement("div");c.className="checkbox-container-box",c.appendChild(l),c.appendChild(s);var u=document.createElement("input");u.type="checkbox",u.setAttribute("id","bulk"),u.value=e.data.next_pickups.bulk.route,u.name="service-signup",u.setAttribute("checked",!0);var d=document.createElement("label");d.innerText="Bulk/Yard Waste",d.setAttribute("for","bulk");var p=document.createElement("div");p.className="checkbox-container-box",p.appendChild(u),p.appendChild(d);var m=document.createElement("div");m.className="checkbox-container-group-box",m.appendChild(i),m.appendChild(c),m.appendChild(p);var f=document.createElement("div");f.className="alert-message-box";var h=document.createElement("button");h.innerText="SIGN ME UP FOR REMINDERS",e.signup.form=document.createElement("form"),e.signup.form.appendChild(m),e.signup.form.appendChild(r),e.signup.form.appendChild(f),e.signup.form.appendChild(h),e.signup.form.addEventListener("submit",(function(t){t.preventDefault(),e.signup.validatePhone(t,e)}))}},{key:"phoneFormat",value:function(e){var t=e.target.value.replace(/\D/g,""),n={0:"(",3:")",6:"-"};e.target.value="";for(var r=0;r<t.length;r++)e.target.value+=(n[r]||"")+t[r]}},{key:"signUpUser",value:function(e,t,n,r,a){var o="string"==typeof t?t:Object.keys(t).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])})).join("&"),i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return i.open("POST",e),i.onload=function(){i.readyState>3&&2==Math.trunc(i.status/100)?a(n,r,i.responseText):r.signup.buildMessage(n,"error",r)},i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.addEventListener("error",(function(e){console.log(e)})),i.send(o),i}},{key:"stripPhoneNumber",value:function(e){var t="";return t=(t=(t=e.split("(")[1]).split(")")[0]+t.split(")")[1]).split("-")[0]+t.split("-")[1],console.log(t),t}},{key:"closeSection",value:function(e){var t=e.target.parentNode.className;t=t.split(" "),e.target.parentNode.className=t[0];try{for(;e.target.parentNode.firstChild;)e.target.parentNode.removeChild(e.target.parentNode.firstChild)}catch(e){}}},{key:"buildMessage",value:function(e,t,n){for(;e.target.childNodes[2].firstChild;)e.target.childNodes[2].removeChild(e.target.childNodes[2].firstChild);var r=document.createElement("button");r.innerText="x",r.className="close-section-btn",r.addEventListener("click",(function(e){e.preventDefault(),n.signup.closeSection(e)}));var a=document.createElement("p");switch(a.innerText=null,e.target.childNodes[2].appendChild(r),e.target.childNodes[2].appendChild(a),e.target.childNodes[2].className=null,t){case"invalid":a.innerText="Invalid phone number. Please enter a valid number.",e.target.childNodes[2].className="alert-message-box active error";break;case"missing":a.innerText="Plese select one or more services to recive reminders.",e.target.childNodes[2].className="alert-message-box active error";break;case"error":a.innerText="There was an error with your request. Please try again.",e.target.childNodes[2].className="alert-message-box active error";break;default:a.innerText="Check your phone for a confirmation message.",e.target.childNodes[2].className="alert-message-box active success"}}},{key:"validatePhone",value:function(e,t){console.log(e);var n=e.target[3].value,r=/^(1\s|1|)?((\(\d{3}\))|\d{3})(\-|\s)?(\d{3})(\-|\s)?(\d{4})$/.test(n);if(n=this.stripPhoneNumber(n),r){for(var a="",o="",i=document.querySelectorAll('.checkbox-container-box > input[type="checkbox"]'),l=0;l<i.length;l++)i[l].checked&&(a+=i[l].value+",",o+=i[l].id+",");if(""!==a){var s={phone_number:n,waste_area_ids:a,service_type:o,address:"test",latitude:t.location.lat,longitude:t.location.lng};this.signUpUser("https://apis.detroitmi.gov/waste_notifier/subscribe/",s,e,t,(function(e,t,n){t.signup.buildMessage(e,"success",t)}))}else this.buildMessage(e,"missing",t)}else this.buildMessage(e,"invalid",t)}}])&&i(t.prototype,n),r&&i(t,r),e}();function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.location={lat:null,lng:null},this.address=null,this.signup=new l,this.currentProvider=null,this.providers={gfl:{url:"http://gflusa.com/residential/detroit/",phone:'<a href="tel:844-464-3587">(844) 464-3587</a>'},advance:{url:"https://www.advanceddisposal.com/mi/detroit/detroit-residential-collection",phone:'<a href="tel:844-233-8764">(844) 233-8764</a>'}},this.data=null}var t,r,a;return t=e,(r=[{key:"closePanel",value:function(e){var t=e.target.parentNode.parentNode.className;t=t.split(" "),e.target.parentNode.parentNode.className=t[0];try{for(;e.target.parentNode.firstChild;)e.target.parentNode.removeChild(e.target.parentNode.firstChild)}catch(e){}}},{key:"createErrorMsg",value:function(e){var t=document.querySelector(".panel .panel-box"),n=document.createElement("button");n.innerText="x",n.className="close-section-btn",n.addEventListener("click",(function(t){t.preventDefault(),e.closePanel(t)})),t.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="70" viewBox="0 0 100 68">\n        <g id="large">\n            <path fill="none" stroke="#F44" d="M55.8 38.5l6.2-1.2c0-1.8-.1-3.5-.4-5.3l-6.3-.2c-.5-2-1.2-4-2.1-6l4.8-4c-.9-1.6-1.9-3-3-4.4l-5.6 3c-1.3-1.6-3-3-4.7-4.1l2-6A30 30 0 0 0 42 8l-3.3 5.4c-2-.7-4.2-1-6.2-1.2L31.3 6c-1.8 0-3.5.1-5.3.4l-.2 6.3c-2 .5-4 1.2-6 2.1l-4-4.8c-1.6.9-3 1.9-4.4 3l3 5.6c-1.6 1.3-3 3-4.1 4.7l-6-2A32.5 32.5 0 0 0 2 26l5.4 3.3c-.7 2-1 4.2-1.2 6.2L0 36.7c0 1.8.1 3.5.4 5.3l6.3.2c.5 2 1.2 4 2.1 6l-4.8 4c.9 1.6 1.9 3 3 4.4l5.6-3c1.4 1.6 3 3 4.7 4.1l-2 6A30.5 30.5 0 0 0 20 66l3.4-5.4c2 .7 4 1 6.1 1.2l1.2 6.2c1.8 0 3.5-.1 5.3-.4l.2-6.3c2-.5 4-1.2 6-2.1l4 4.8c1.6-.9 3-1.9 4.4-3l-3-5.6c1.6-1.3 3-3 4.1-4.7l6 2A32 32 0 0 0 60 48l-5.4-3.3c.7-2 1-4.2 1.2-6.2zm-13.5 4a12.5 12.5 0 1 1-22.6-11 12.5 12.5 0 0 1 22.6 11z"/>\n            <animateTransform attributeName="transform" begin="0s" dur="3s" from="0 31 37" repeatCount="indefinite" to="360 31 37" type="rotate"/>\n        </g>\n        <g id="small">\n            <path fill="none" stroke="#F44" d="M93 19.3l6-3c-.4-1.6-1-3.2-1.7-4.8L90.8 13c-.9-1.4-2-2.7-3.4-3.8l2.1-6.3A21.8 21.8 0 0 0 85 .7l-3.6 5.5c-1.7-.4-3.4-.5-5.1-.3l-3-5.9c-1.6.4-3.2 1-4.7 1.7L70 8c-1.5 1-2.8 2-3.9 3.5L60 9.4a20.6 20.6 0 0 0-2.2 4.6l5.5 3.6a15 15 0 0 0-.3 5.1l-5.9 3c.4 1.6 1 3.2 1.7 4.7L65 29c1 1.5 2.1 2.8 3.5 3.9l-2.1 6.3a21 21 0 0 0 4.5 2.2l3.6-5.6c1.7.4 3.5.5 5.2.3l2.9 5.9c1.6-.4 3.2-1 4.8-1.7L86 34c1.4-1 2.7-2.1 3.8-3.5l6.3 2.1a21.5 21.5 0 0 0 2.2-4.5l-5.6-3.6c.4-1.7.5-3.5.3-5.1zM84.5 24a7 7 0 1 1-12.8-6.2 7 7 0 0 1 12.8 6.2z"/>\n            <animateTransform attributeName="transform" begin="0s" dur="2s" from="0 78 21" repeatCount="indefinite" to="-360 78 21" type="rotate"/>\n        </g>\n        </svg>\n        <h3>No Information found.</h3>\n        ',t.prepend(n),document.querySelector("#app .panel").className="panel active"}},{key:"createPanel",value:function(e){console.log(e);var t=document.querySelector(".panel .panel-box"),n=document.createElement("button");n.innerText="x",n.className="close-section-btn",n.addEventListener("click",(function(t){t.preventDefault(),e.closePanel(t)}));var r=e.buildNextPickup(e);t.innerHTML="\n            <h2>".concat(e.address,'</h2>\n            <section class="sms-signup-box">\n            </section>\n            ').concat(r,"\n        "),t.prepend(n),e.signup.buildForm(e),document.querySelector(".panel .panel-box .sms-signup-box").appendChild(e.signup.form),document.querySelector("#app .panel").className="panel active"}},{key:"buildNextPickup",value:function(e){return console.log(e),console.log(e.data.next_pickups.trash.next_pickup),'\n        <section class="waste-services">\n        <div class="group">\n            <span class="header">PROVIDER</span>\n            <p><a href="'.concat(e.providers[e.currentProvider].url,'" target="_blank">').concat(e.currentProvider,"</a> - ").concat(e.providers[e.currentProvider].phone,'</p>\n        </div>\n        <div class="group">\n            <span class="header">GARBAGE</span>\n            <p>').concat(n(e.data.next_pickups.trash.next_pickup).format("dddd - MMM Do"),'</p>\n        </div>\n        <div class="group">\n            <span class="header">CURBSIDE RECYCLE</span>\n            <p>').concat(n(e.data.next_pickups.recycling.next_pickup).format("dddd - MMM Do"),'</p>\n        </div>\n        <div class="group">\n            <span class="header">BULK</span>\n            <p>').concat(n(e.data.next_pickups.bulk.next_pickup).format("dddd - MMM Do"),"</p>\n        </div>\n        ").concat(e.data.next_pickups["yard waste"]?'\n        <div class="group">\n            <span class="header">YARD</span>\n            <p>'.concat(n(e.data.next_pickups["yard waste"].next_pickup).format("dddd - MMM Do"),"</p>\n        </div></sections>"):"","\n        ")}}])&&s(t.prototype,r),a&&s(t,a),e}();function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var d=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.form=null,this._controller=n,this.init(document.getElementById(t),this)}var n,r,a;return n=e,(r=[{key:"init",value:function(e,t){var n=this,r=document.createElement("form"),a=document.createElement("label"),o=document.createElement("input"),i=(document.createElement("ul"),document.createElement("datalist")),l=document.createElement("i");r.addEventListener("submit",(function(e){n.submit(e,t)})),l.className="fas fa-map-marker-alt",a.innerText="Find My Home:",a.setAttribute("for","geocoder-input"),o.type="text",o.setAttribute("list","addresses-list"),o.placeholder="Enter address",o.setAttribute("id","geocoder-input"),o.setAttribute("autocomplete","off"),o.addEventListener("keyup",(function(e){n.inputChange(e,t)})),i.setAttribute("id","addresses-list"),r.appendChild(a),r.appendChild(o),r.appendChild(l),r.appendChild(i),e.appendChild(r),this.form=r}},{key:"supplementGeocoder",value:function(e,n,r){var a=e.split(",");a=(a=a[0]).split(" ");var o="",i=a.length;a.forEach((function(e,t){o+=e,t<i&&t+1!==i&&(o+="+")}));var l="https://gis.detroitmi.gov/arcgis/rest/services/DoIT/CompositeGeocoder/GeocodeServer/findAddressCandidates?Street=&City=&ZIP=&SingleLine=".concat(o,"&category=&outFields=User_fld&maxLocations=4&outSR=4326&searchExtent=&location=&distance=&magicKey=&f=json");try{fetch(l).then((function(e){return e.json()})).then((function(e){if("suggestions"===r)e.candidates.forEach((function(e){var t=document.createElement("option");""===e.attributes.User_fld?(t.value=e.address,t.setAttribute("data-parsel","no-parcel")):(t.value="".concat(e.address," RECOMMENDED"),t.setAttribute("data-parsel",e.attributes.User_fld)),t.onclick=function(e){n.selectSuggestion(e,n)},n.form.childNodes[3].appendChild(t)}));else{var a="https://services2.arcgis.com/qvkbeam7Wirps6zC/arcgis/rest/services/City_of_Detroit_Boundary/FeatureServer/0/query?where=&objectIds=&time=&geometry=".concat(e.candidates[0].location.x,"%2C+").concat(e.candidates[0].location.y,"&geometryType=esriGeometryPoint&inSR=4326&spatialRel=esriSpatialRelIntersects&resultType=none&distance=0.0&units=esriSRUnit_Meter&returnGeodetic=false&outFields=4326&returnGeometry=true&returnCentroid=false&multipatchOption=xyFootprint&maxAllowableOffset=&geometryPrecision=&outSR=&datumTransformation=&applyVCSProjection=false&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnDistinctValues=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&returnExceededLimitFeatures=true&quantizationParameters=&sqlFormat=none&f=geojson&token=");try{fetch(a).then((function(e){return e.json()})).then((function(r){if(console.log(r),r.features.length){n._controller.panel.createErrorMsg(n._controller.panel);var a=null;e.candidates.forEach((function(e){""!==e.attributes.User_fld&&n._controller.checkParcelValid(e.attributes.User_fld)&&(a=e)})),console.log(a),null==a&&e.candidates[0].location,console.log("Found location");var o=t.point([a.location.x,a.location.y]);n._controller.panel.address=a.address,n._controller.queryLayer(n._controller,"wasteRoutes",o)}else console.log("no locations found"),n._controller.panel.createErrorMsg(n._controller.panel)}))}catch(e){console.log("error found"),n._controller.panel.createErrorMsg(n._controller.panel)}}}))}catch(e){console.log("error found"),n._controller.panel.createErrorMsg(n._controller.panel)}}},{key:"selectSuggestion",value:function(e,t){var n=null;"no-parcel"===(n="SPAN"===e.target.tagName?e.target.parentNode:e.target).attributes[0].value?(t.clearSuggestions(t),t.supplementGeocoder(n.innerText,t,"submit")):t.supplementGeocoder(n.innerText,t,"submit")}},{key:"inputChange",value:function(e,t){switch(e.key){case"Enter":""!=e.target.value&&null!=e.target.value&&t.supplementGeocoder(e.target.value,t,"submit");break;case"ArrowDown":case"ArrowUp":case"ArrowRight":case"ArrowLeft":break;case void 0:""!=e.target.value&&null!=e.target.value&&t.supplementGeocoder(e.target.value,t,"submit");break;default:t.clearSuggestions(t),t.supplementGeocoder(e.target.value,t,"suggestions")}}},{key:"clearSuggestions",value:function(e){for(;e.form.childNodes[3].firstChild;)e.form.childNodes[3].removeChild(e.form.childNodes[3].firstChild)}},{key:"submit",value:function(e,t){e.preventDefault(),t.supplementGeocoder(e.target[0].value,t,"submit")}}])&&u(n.prototype,r),a&&u(n,a),e}();function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var m,f=null;var h=function(){return f||(f=function(){try{throw new Error}catch(t){var e=(""+t.stack).match(/(https?|file|ftp):\/\/[^)\n]+/g);if(e)return(""+e[0]).replace(/^((?:https?|file|ftp):\/\/.+)\/[^/]+$/,"$1")+"/"}return"/"}()),f};m=h()+"marker-icon.8e6b47f8.png";var g;g=h()+"marker-shadow.ffd14a96.png",window,new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.month=n().month()+1,this.year=n().year(),this.point=null,this.map=null,this.layers={},this.panel=new c,this.geocoder=new d("geocoder",this),this.initialLoad(this)}var t,o,i;return t=e,(o=[{key:"initialLoad",value:function(e){e.map=r.map("map").setView([42.36,-83.1],12),r.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(e.map),e.layers.wasteRoutes=a.featureLayer({url:"https://gis.detroitmi.gov/arcgis/rest/services/DPW/2019Services/MapServer/0",simplifyFactor:.5,precision:5,style:function(e){switch(e.properties.day){case"monday":return{color:"blue",weight:2};case"tuesday":return{color:"red",weight:2};case"wednesday":return{color:"green",weight:2};case"thursday":return{color:"yellow",weight:2};default:return{color:"purple",weight:2}}}}).addTo(e.map),e.map.on("click",(function(t){console.log(t),e.queryLayer(e,"wasteRoutes",t.latlng)}))}},{key:"queryLayer",value:function(e,t,n){console.log(n);var a=!1,o=r.icon({iconUrl:m,iconSize:[25,35],iconAnchor:[25,35],popupAnchor:[-3,-76],shadowUrl:g,shadowSize:[68,95],shadowAnchor:[22,94]}),i=null;n.geometry?i={lat:n.geometry.coordinates[1],lng:n.geometry.coordinates[0]}:(a=!0,i=n);var l=r.layerGroup().addTo(e.map);e.layers[t].query().intersects(n).run((function(t,n,s){t?console.log(t):(e.point?(e.point.clearLayers(),e.point=l.addLayer(r.marker(i,{icon:o}))):e.point=l.addLayer(r.marker(i,{icon:o})),e.map.flyTo(i,15),e.panel.currentProvider=n.features[0].properties.contractor,console.log(n.features),fetch("https://apis.detroitmi.gov/waste_schedule/details/".concat(n.features[0].properties.FID,"/year/").concat(e.year,"/month/").concat(e.month,"/")).then((function(t){t.json().then((function(t){console.log(t),e.panel.location.lat=i.lat,e.panel.location.lng=i.lng,e.panel.data=t,a?fetch("https://gis.detroitmi.gov/arcgis/rest/services/DoIT/StreetCenterlineLatLng/GeocodeServer/reverseGeocode?location=".concat(e.panel.location.lng,"%2C+").concat(e.panel.location.lat,"&distance=&outSR=&f=pjson")).then((function(t){t.json().then((function(t){console.log(t),e.panel.address=t.address.Street,e.panel.createPanel(e.panel)}))})).catch((function(e){console.log(e)})):e.panel.createPanel(e.panel)}))})).catch((function(e){console.log(e)})))}))}},{key:"checkParcelValid",value:function(e){return/\d/.test(e)}}])&&p(t.prototype,o),i&&p(t,i),e}());